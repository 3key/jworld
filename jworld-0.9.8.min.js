(function(e){e.fn.world=function(e,n,r){var i=this;var s=this.length;if(s===0)return false;if(typeof e!=="string"){if(typeof n==="object"){r=n}n=e;if(typeof n==="undefined")n={};e="set"}var o;if(e==="set"){var u;for(var a=0;a<s;a++){u=this[a];var f=t.items[u.id]||null;if(f==null){if(!t.running){t.running=true;t.iid=setInterval(t.interval,1e3/t.frameRate)}f=new t.View3d(u,0,0,0,n.setupChildNodes||true);t.items[u.id]=f}var l;for(var c in n){l=n[c];o=typeof f[c];if(o==="undefined"){o=typeof f["set"+c];if(o!=="undefined"){if(o==="function"){f["set"+c](l)}else{f["set"+c]=l}}}else if(o==="function"){f[c](l)}else{f[c]=l}}if(f.invalidSize)f.updateSize()}return this}else if(e==="get"){var h=t.items[this[0].id];if(h){var p=typeof r==="object"?r:n;for(var c in n){o=typeof h[c];if(o!=="undefined"){if(o==="function"){p[c]=h[c]()}else{p[c]=h[c]}}else{o=typeof h["get"+c];if(o!=="undefined"){if(o==="function"){p[c]=h["get"+c]()}else{p[c]=h["get"+c]}}}}return p}else{return typeof r==="object"?r:null}}else if(e=="move"||e=="rotate"){return this.each(function(i,s){var o=t.items[s.id]||null;if(o){o[e](n,r)}})}else if(e=="reset"||e=="update"||e=="updateSize"){return this.each(function(n,r){var i=t.items[r.id]||null;if(i){i[e]()}})}else if(e==="matrixTransition"){if(typeof n==="string"){return this.each(function(e,r){var i=t.items[r.id]||null;if(i){if(i instanceof t.View3d){t.cssProp(i.container,"transition",t.pfxCss+"transform "+n)}else{t.cssProp(r,"transition",t.pfxCss+"transform "+n)}}})}return this}else if(e==="css"){if(typeof n==="string"&&typeof r==="string"){return this.each(function(e,i){var s=t.items[i.id]||null;if(s){if(s instanceof t.View3d){t.cssProp(s.container,n,r)}else{t.cssProp(i,n,r)}}})}}else if(e=="browserPrefix"){return t.pfx}else if(e=="cssPrefix"){return t.pfxCss}else if(e==="support"){return t.support}else if(e==="frameRate"){t.frameRate=n;if(t.iid!=null){clearInterval(t.iid);t.iid=setInterval(t.interval,1e3/t.frameRate)}}else{var d=typeof n;if(d==="undefined"){var f=t.items[this[0].id];if(f){o=typeof f[e];if(o!=="undefined"){if(o==="function"){return f[e]()}else{return f[e]}}else{o=typeof f["get"+e];if(o!=="undefined"){if(o==="function"){return f["get"+e]()}else{return f["get"+e]}}}}}else{var f=t.items[this[0].id];if(f){o=typeof f[e];if(o!=="undefined"){if(o==="function"){try{f[e](n)}catch(v){var m}}else{if(typeof f[e]!=="undefined"){f[e]=n}}}else{o=typeof f["set"+e];if(o!=="undefined"){if(o==="function"){try{f["set"+e](n)}catch(v){var m}}else{if(typeof f["set"+e]!=="undefined"){f["set"+e]=n}}}}if(f.invalidSize)f.updateSize()}}}return this};e.fn.world.core={items:{},frameRate:50,iid:null,pfx:"",pfxCss:"",running:false,tu:[],cssProp:function(e,n,r){var i=t.pfx;if(e)e.style[i+(i==""?n:n.charAt(0).toUpperCase()+n.substring(1))]=r},setInvalid:function(e){for(var n=0;n<t.tu.length;n++){if(t.tu[n]===e){return}}t.tu.push(e)},interval:function(){if(t.tu.length>0){var e=t.tu;for(var n=e.length-1;n>=0;n--){e[n].update()}t.tu=[]}},Matrix3d:function(){this.id()},Object3d:function(){this.create()},View3d:function(e,n,r,i,s){var o=this;o.create();o._ortho=false;o.cDiv=o.container=o.wrap1=o.wrap2=null;o._perspective=0;o.sprites=[];o._width=0;o._height=0;o.createView=function(e,n,r,i,s){var o=this;if(n==0||n==null)n=e.getAttribute("data-width")||e.width||e.offsetWidth||800;if(r==0||r==null)r=e.getAttribute("data-height")||e.height||e.offsetHeight||600;if(i==0||i==null)i=(Number(e.getAttribute("data-fov"))||55)*Math.PI/180;o._width=n;o._height=r;if(e){o.cDiv=e;e.style.width=n+"px";e.style.height=r+"px";e.style.overflow="hidden";e.style.position="relative";o.container=document.createElement("div");o.wrap1=document.createElement("div");o.wrap2=document.createElement("div");o.wrap1.appendChild(o.wrap2);o.wrap2.appendChild(o.container);if(t.support){t.cssProp(o.wrap2,"transformStyle","preserve-3d");t.cssProp(o.container,"transformStyle","preserve-3d")}e.appendChild(o.wrap1);o.wrap1.style.position="absolute";o.updateSize();t.setupDataTransform(e,o);o.setfov(i);if(s!=false){o.addElements(e)}}};o.addElements=function(e){var t,n;if(typeof e.length!=="undefined"){t=e;for(var r=t.length-1;r>=0;r--){n=t[r];if(n.nodeType===1&&n!==this.wrap1){this.add(n)}}}else{t=e.childNodes;for(var r=t.length-1;r>=0;r--){n=t.item(r);if(n.nodeType===1&&n!==this.wrap1){this.add(n)}}}};o.add=function(e){if(e.nodeType===1){var t=this.newSprite(e)}};o.removeElements=function(e){var t,n;if(typeof e.length!=="undefined"){t=e;for(var r=t.length-1;r>=0;r--){n=t[r];if(n.nodeType===1&&n!==this.wrap1){this.remove(n)}}}else{t=e.childNodes;for(var r=t.length-1;r>=0;r--){n=t.item(r);if(n.nodeType===1&&n!==this.wrap1){this.remove(n)}}}};o.remove=function(e){if(e.nodeType===1){for(var n=0;n<this.sprites.length;n++){if(this.sprites[n].div===e){this.sprites.splice(n,1);this.container.removeChild(e);delete t.items[e.id];break}}}};o.getwidth=function(){return this._width};o.setwidth=function(e){this._width=e;this.invalidSize=true};o.getheight=function(){return this._height};o.setheight=function(e){this._height=e;this.invalidSize=true};o.setortho=function(e){this._ortho=Boolean(e);this.setfov(this._fov)};o._fov=0;o.getfov=function(){return this._fov};o.setfov=function(e){this._fov=e;this.setperspective(this.getFocalLength());t.setInvalid(this)};o.setFocalLength=function(e){this._fov=Math.atan2(this._height/2,e)*2};o.getFocalLength=function(){var e=this._fov/2;return this._height/2*(Math.cos(e)/Math.sin(e))};o.setperspective=function(e){this._perspective=e;this.setFocalLength(e);if(this._ortho){if(t.support)t.cssProp(this.wrap2,"perspective","none")}else{if(t.support)t.cssProp(this.wrap2,"perspective",e+(t.pfx=="Webkit"?"":"px"))}this.update()};o.update=function(){var e=this;if(t.support){var n=e.tgv;var r=-(e._x*n.a+e._y*n.b+e._z*n.c);var i=e._x*n.e+e._y*n.f+e._z*n.g;var s=e._x*n.i+e._y*n.j+e._z*n.k+this._perspective;var o=1e-5;if(r<o&&r>-o)r=0;if(i<o&&i>-o)i=0;if(s<o&&s>-o)s=0;t.cssProp(this.container,"transform","matrix3d("+n.a+","+ -n.e+","+ -n.i+",0,"+n.b+","+ -n.f+","+ -n.j+",0,"+n.c+","+ -n.g+","+ -n.k+",0,"+r+","+i+","+s+",1)")}};o.updateSize=function(){var e;o.invalidSize=false;if(t.support){e=this.wrap1.style;e.left=Math.floor(this._width/2)+"px";e.top=Math.floor(this._height/2)+"px"}e=this.cDiv.style;e.width=this._width+"px";e.height=this._height+"px";this.setfov(this._fov)};o.newSprite=function(e){var n=new t.Sprite3d;n.setDiv(e);this.sprites.push(n);t.items[e.id]=n;n.updateSize();t.setupDataTransform(e,n);n.update();this.container.appendChild(e);return n};o.createView(e,n,r,i,s)},setupDataTransform:function(e,n){var r,i,s;for(var o in e.attributes){r=e.attributes[o].name;if(r&&r.charAt(0)=="d"){i=e.getAttribute(r);s=Number(i);switch(r){case"data-x":case"data-position-x":n.setx(s);break;case"data-y":case"data-position-y":n.sety(s);break;case"data-z":case"data-position-z":n.setz(s);break;case"data-rx":case"data-rotate-x":n.setrotateX(s);break;case"data-ry":case"data-rotate-y":n.setrotateY(s);break;case"data-rz":case"data-rotate-z":n.setrotateZ(s);break;case"data-sx":case"data-scale-x":n.setscaleX(s);break;case"data-sy":case"data-scale-y":n.setscaleY(s);break;case"data-sz":case"data-scale-z":n.setscaleZ(s);break;case"data-mx":case"data-move-x":n.moveX(s);break;case"data-my":case"data-move-y":n.moveY(s);break;case"data-mz":case"data-move-z":n.moveZ(s);break;case"data-lrx":case"data-local-rotate-x":n.localRotateX(s);break;case"data-lry":case"data-local-rotate-y":n.localRotateY(s);break;case"data-lrz":case"data-local-rotate-z":n.localRotateZ(s);break;case"data-ortho":case"data-oorthographic":if(n instanceof t.View3d)n.setortho(Boolean(i));break;default:break}}}}};var t=e.fn.world.core;t.Matrix3d.prototype={id:function(){var e=this;e.a=e.f=e.k=1;e.b=e.c=e.e=e.g=e.i=e.j=0}};t.Object3d.prototype={create:function(){var e=this;e.invalidSize=true;e.tgv=new t.Matrix3d;e._x=0;e._y=0;e._z=0;e._scaleX=1;e._scaleY=1;e._scaleZ=1;e.rx=0;e.ry=0;e.rz=0},getx:function(){return this._x},setx:function(e){this._x=e;t.setInvalid(this)},gety:function(){return this._y},sety:function(e){this._y=e;t.setInvalid(this)},getz:function(){return this._z},setz:function(e){this._z=e;t.setInvalid(this)},setoffsetX:function(e){this._x+=e;t.setInvalid(this)},setoffsetY:function(e){this._y+=e;t.setInvalid(this)},setoffsetZ:function(e){this._z+=e;t.setInvalid(this)},getrotateX:function(){return this.rx==0?0:this.rx/Math.PI*180},setrotateX:function(e){this.rx=e==0?0:e*Math.PI/180;this.initAxis();t.setInvalid(this)},getrotateY:function(){return this.ry==0?0:this.ry/Math.PI*180},setrotateY:function(e){this.ry=e==0?0:e*Math.PI/180;this.initAxis();t.setInvalid(this)},getrotateZ:function(){return this.rz==0?0:this.rz/Math.PI*180},setrotateZ:function(e){this.rz=e==0?0:e*Math.PI/180;this.initAxis();t.setInvalid(this)},setoffsetRotateX:function(e){this.rx+=e==0?0:e*Math.PI/180;this.initAxis();t.setInvalid(this)},setoffsetRotateY:function(e){this.ry+=e==0?0:e*Math.PI/180;this.initAxis();t.setInvalid(this)},setoffsetRotateZ:function(e){this.rz+=e==0?0:e*Math.PI/180;this.initAxis();t.setInvalid(this)},move:function(e,n){this._x+=e.x*n;this._y+=e.y*n;this._z+=e.z*n;t.setInvalid(this)},moveX:function(e){this.move(this.getXAxis(),e)},moveY:function(e){this.move(this.getYAxis(),e)},moveZ:function(e){this.move(this.getZAxis(),e)},rotate:function(e,n){if(Math.abs(n)<5e-4)return;n=n*Math.PI/180;var r=e.x,i=e.y,s=e.z;var o=Math.sqrt(r*r+i*i+s*s);r/=o;i/=o;s/=o;var u=Math.sin(n);var a=Math.cos(n);var f=1-a;var l=u*r;var c=u*i;var h=u*s;var p=i*r*f;var d=i*s*f;var v=s*r*f;var m=r*r*f+a;var g=p+h;var y=v-c;var b=p-h;var w=i*i*f+a;var E=d+l;var S=v+c;var x=d-l;var T=s*s*f+a;var N=this.tgv;var C=N.a;var k=N.b;var L=N.c;var A=N.e;var O=N.f;var M=N.g;var _=N.i;var D=N.j;var P=N.k;N.a=C*m+k*b+L*S;N.b=C*g+k*w+L*x;N.c=C*y+k*E+L*T;N.e=A*m+O*b+M*S;N.f=A*g+O*w+M*x;N.g=A*y+O*E+M*T;N.i=_*m+D*b+P*S;N.j=_*g+D*w+P*x;N.k=_*y+D*E+P*T;var H=1e-5;if(N.a<H&&N.a>-H)N.a=0;if(N.b<H&&N.b>-H)N.b=0;if(N.c<H&&N.c>-H)N.c=0;if(N.e<H&&N.e>-H)N.e=0;if(N.f<H&&N.f>-H)N.f=0;if(N.g<H&&N.g>-H)N.g=0;if(N.i<H&&N.i>-H)N.i=0;if(N.j<H&&N.j>-H)N.j=0;if(N.k<H&&N.k>-H)N.k=0;t.setInvalid(this);this.updateRotation(N)},localRotateX:function(e){this.rotate(this.getXAxis(),e)},localRotateY:function(e){this.rotate(this.getYAxis(),e)},localRotateZ:function(e){this.rotate(this.getZAxis(),e)},updateRotation:function(e){var t=Math.asin(e.j);this.ry=0;this.rx=-t;if(t<Math.PI/2){if(t>-Math.PI/2){this.rz=-Math.atan2(-e.b,e.f);this.ry=-Math.atan2(-e.i,e.k)}else{this.rz=Math.atan2(e.b,e.a)}}else{this.rz=-Math.atan2(e.c,e.a)}},initAxis:function(){var e=-this.rx;var t=this.ry;var n=-this.rz;var r=Math.cos(e);var i=Math.sin(e);var s=Math.cos(t);var o=Math.sin(t);var u=Math.cos(n);var a=Math.sin(n);var f=this.tgv;f.a=u*s-a*-i*o;f.b=-a*r;f.c=u*-o-a*-i*s;f.e=a*s+u*-i*o;f.f=u*r;f.g=a*-o+u*-i*s;f.i=r*o;f.j=i;f.k=r*s;var l=1e-5;if(f.a<l&&f.a>-l)f.a=0;if(f.b<l&&f.b>-l)f.b=0;if(f.c<l&&f.c>-l)f.c=0;if(f.e<l&&f.e>-l)f.e=0;if(f.f<l&&f.f>-l)f.f=0;if(f.g<l&&f.g>-l)f.g=0;if(f.i<l&&f.i>-l)f.i=0;if(f.j<l&&f.j>-l)f.j=0;if(f.k<l&&f.k>-l)f.k=0},getXAxis:function(){return{x:this.tgv.a,y:this.tgv.b,z:this.tgv.c}},getYAxis:function(){return{x:this.tgv.e,y:this.tgv.f,z:this.tgv.g}},getZAxis:function(){return{x:this.tgv.i,y:this.tgv.j,z:this.tgv.k}},getscaleX:function(){return this._scaleX},setscaleX:function(e){this._scaleX=e;t.setInvalid(this)},getscaleY:function(){return this._scaleY},setscaleY:function(e){this._scaleY=e;t.setInvalid(this)},getscaleZ:function(){return this._scaleZ},setscaleZ:function(e){this._scaleZ=e;t.setInvalid(this)},reset:function(){this.tgv.id();this._x=this._y=this._z=0;this.rx=this.ry=this.rz=0;this._scaleX=this._scaleY=this._scaleZ=1}};t.View3d.prototype=new t.Object3d;t.Sprite3d=function(){var e=this;e.create();e.div=null;e.updateSize=function(){var e=this.div;var n=Math.floor(e.width>0?e.width*.5:e.offsetWidth*.5);var r=Math.floor(e.height>0?e.height*.5:e.offsetHeight*.5);t.cssProp(e,"transformOrigin",n+"px "+r+"px 0px");e.style.left="-"+n+"px";e.style.top="-"+r+"px"};e.update=function(){if(t.support){var e=this;var n=e.tgv;t.cssProp(e.div,"transform","translate3d("+e._x+"px,"+e._y+"px,"+e._z+"px) rotateY("+e.getrotateY()+"deg) rotateX("+e.getrotateX()+"deg) rotateZ("+e.getrotateZ()+"deg) scale3d("+e._scaleX+","+ -e._scaleY+","+ -e._scaleZ+")")}};e.setDiv=function(e){this.div=e;e.style.position="absolute";t.cssProp(e,"transformStyle","preserve-3d")}};t.Sprite3d.prototype=new t.Object3d;t.support=function(){var e,n,r=document.createElement("div"),i=["Webkit","Moz","O","khtml","ms"];for(e=0;e<i.length;e++){n=i[e];if(n+"Perspective"in r.style){t.pfx=n;t.pfxCss="-"+n.toLowerCase()+"-";return true}}return false}()})(jQuery)